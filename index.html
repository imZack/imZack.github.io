<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="nodejs, python, linux, mac, opensource" />





  <link rel="alternate" href="/atom.xml" title="Somewhere I Belong" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Somewhere I Belong">
<meta property="og:url" content="http://yulun.me/index.html">
<meta property="og:site_name" content="Somewhere I Belong">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Somewhere I Belong">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Somewhere I Belong </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-5959305-16', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Somewhere I Belong</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">All about geek's life</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-projects">
          <a href="/projects" rel="section">
            
              <i class="menu-item-icon fa fa-question-circle fa-fw"></i> <br />
            
            開源專案
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/python2-threading-queue-timeout-monotonic/" itemprop="url">
                  Python 2.7 Threading / Queue 的 timeout 問題
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-04-29T00:21:59+00:00" content="4月 29 2016">
              4月 29 2016
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/python2-threading-queue-timeout-monotonic/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/python2-threading-queue-timeout-monotonic/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近遇到一個很坑的問題…</p>
<p>那就是系統時間只要 <strong>倒退嚕</strong> 某些 Python thread 就會卡住 (其實不是卡住)</p>
<p>我們都知道系統時間是有可能會改變的 (藉由 NTP, 基地台校時, 手動, 等方式)，但是很多程式的 timeout 相關機制設計是有缺陷的。舉個例子：一個 10 秒的 timeout 可以寫成 <code>起始系統時間 - 現在系統時間 &gt;= 10</code> 就執行</p>
<p>淺而易見地，如果今天時間回溯如：2016 調整到 2000，那這樣這個 timeout 要等 <strong>16 年</strong> 才會觸發…</p>
<p>所以通常，有幾種做法：</p>
<ol>
<li><p>使用 monotonic time</p>
<blockquote>
<p>The kernel call for time functions. Using CLOCK_MONOTONIC is typically better than using CLOCK_REALTIME because the monotonic clock is always increasing, so you don’t have to worry about someone’s changing the clock.<br>ref: <a href="http://www.qnx.com/developers/docs/6.4.1/neutrino/technotes/time.html" rel="external nofollow" target="_blank">http://www.qnx.com/developers/docs/6.4.1/neutrino/technotes/time.html</a></p>
</blockquote>
</li>
<li><p>取兩個時間相減後的絕對值 (缺點：並非真正的 timeout 時間，但可以抵抗系統時間往前。如果你沒辦法取得 monotonic time 也許也是一個方式)</p>
</li>
</ol>
<p>在 Python 世界中，一直到 <a href="https://www.python.org/dev/peps/pep-0418/" rel="external nofollow" target="_blank">PEP 418 – Add monotonic time, performance counter, and process time functions</a>，規範 stdlib monotonic time 的機制。(可能是考量到跨平台與可移植性…所以直到 2012 才加入這個功能)</p>
<p>Anyway, Python 2.7 中，<code>Queue.get()</code>, 以及 <code>threading.condition</code> 中都使用了 <code>time.time()</code> 來判斷 timeout，如此一來只要使用者不慎將時間往回調你的程式行為可能就不如預期。<br>(題外話：系統時間大幅度往前實際上是很少發生的，也應該要被避免。因為其他背景執行程式如何實作 timeout? 或是其他功能可能會有預期外的行為發生。)</p>
<p>可以看一下 Python 2.7 source code 其中的 <code>_time()</code> 是 <code>time.time()</code>，所以可以明顯地看出如果系統時間往回調，這邊的 <code>threading.condition.wait()</code> 會行為異常。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">endtime = _time() + timeout</span><br><span class="line">delay = <span class="number">0.0005</span> <span class="comment"># 500 us -&gt; initial delay of 1 ms</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    gotit = waiter.acquire(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> gotit:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    remaining = endtime - _time()</span><br><span class="line">    <span class="keyword">if</span> remaining &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    delay = min(delay * <span class="number">2</span>, remaining, <span class="number">.05</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上取自 <a href="https://github.com/python/cpython/blob/2.7/Lib/threading.py#L349-L358" rel="external nofollow" target="_blank">https://github.com/python/cpython/blob/2.7/Lib/threading.py#L349-L358</a></p>
</blockquote>
<p>像這樣的例子在 Python code base 還有很多，詳細請見這個 patch 將所有 timeout 全部替換成使用 monotonic 來計算</p>
<ul>
<li>patches: <a href="http://bugs.python.org/review/22043" rel="external nofollow" target="_blank">http://bugs.python.org/review/22043</a></li>
<li>issue: <a href="http://bugs.python.org/issue22043" rel="external nofollow" target="_blank">http://bugs.python.org/issue22043</a></li>
</ul>
<p>最後補上一些前人的痛：</p>
<ul>
<li><a href="https://bugs.python.org/issue1508864" rel="external nofollow" target="_blank">threading.Timer/timeouts break on change of win32 local time
</a></li>
<li><a href="http://ephrain.pixnet.net/blog/post/62284744" rel="external nofollow" target="_blank">[Python] Debug python 程式 hang 在 Queue.get() 的問題
</a></li>
</ul>
<p>最後我想說：<strong>Let’s upgrade to Python 3.5!</strong></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/diff-files-in-two-folders-linux/" itemprop="url">
                  比對兩個資料夾下的檔並輸出彩色 diff
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-03-24T20:42:14+00:00" content="3月 24 2016">
              3月 24 2016
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/diff-files-in-two-folders-linux/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/diff-files-in-two-folders-linux/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>平常都在 git repo 內做 diff，一時之間不知道要怎麼比對兩個資料夾底下的檔案</p>
<p>這邊作一下紀錄…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">λ ~/temp/ diff -bur FOLDER_1 FOLDER_2</span><br></pre></td></tr></table></figure>
<p>會發現輸出的 diff <strong>居然沒有顏色</strong>…</p>
<p>於是乎又找到 <code>colofdiff</code></p>
<p>直接 <code>apt-get install colordiff</code> 即可，就會變成這樣</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">diff -bur FOLDER_1 FOLDER_2 | colordiff</span><br><span class="line"></span><br><span class="line">// 存起來</span><br><span class="line">diff -bur FOLDER_1 FOLDER_2 | colordiff &gt; your.diff</span><br></pre></td></tr></table></figure>
<p>打完收工。</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/setup-tftp-server-on-ubuntu/" itemprop="url">
                  架設 tftp server 在 Ubuntu 環境
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-03T23:53:00+00:00" content="1月 3 2016">
              1月 3 2016
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/setup-tftp-server-on-ubuntu/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/setup-tftp-server-on-ubuntu/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://en.wikipedia.org/wiki/Trivial_File_Transfer_Protocol" rel="external nofollow" target="_blank">TFTP (Trivial File Transfer Protocol)</a>，是很常見的通訊協議用在一些小系統上，如 cisco 韌體更新、或是有些廠家會 BIOS 內建 tftp 下載 rom 檔功能。如此輕巧簡易的通訊協議就很常派上用場。</p>
<p>Reference: <a href="http://askubuntu.com/questions/201505/how-do-i-install-and-run-a-tftp-server" rel="external nofollow" target="_blank">How do I install and run a TFTP server?</a></p>
<ol>
<li><p>先安裝好相關套件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install xinetd tftpd tftp</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增一組設定檔，放置於 <code>/etc/xinetd.d/tftp</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service tftp</span><br><span class="line">&#123;</span><br><span class="line">  protocol        = udp</span><br><span class="line">  port            = 69</span><br><span class="line">  socket_type     = dgram</span><br><span class="line">  wait            = yes</span><br><span class="line">  user            = nobody</span><br><span class="line">  server          = /usr/sbin/in.tftpd</span><br><span class="line">  server_args     = /tftpboot</span><br><span class="line">  disable         = no</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>這邊可以看到開啟了 udp 在 69 port、user 是 nobody、server 是 /usr/sbin/in.tftpd、而帶入的參數即為我們放置檔案的資料夾 /tftpboot</p>
<ol>
<li><p>新增 /tftpboot 資料夾，並且修改權限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mkdir /tftpboot</span><br><span class="line">sudo chmod -R 777 /tftpboot</span><br><span class="line">sudo chown -R nobody /tftpboot</span><br></pre></td></tr></table></figure>
</li>
<li><p>將 xinetd 重新啟動</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo service xinetd restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>放置一任意檔案，然後用 tftp 測試</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tftp localhost</span><br><span class="line">tftp&gt; get test</span><br><span class="line">Sent xxx bytes in 0.0 seconds</span><br><span class="line"></span><br><span class="line">tftp&gt; quit</span><br><span class="line"></span><br><span class="line">cat test</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>大功告成，打完收工。</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/docker-container-network-bandwidth-iptables-namespace/" itemprop="url">
                  查看 Docker 每個 Container 流量 (使用 ip nets 指令)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-03T23:17:12+00:00" content="1月 3 2016">
              1月 3 2016
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/docker-container-network-bandwidth-iptables-namespace/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/docker-container-network-bandwidth-iptables-namespace/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>忘記是哪一天，忽然想檢查一下各別 Container 的流量用了多少，上網隨手找了一下，看到可以使用 <strong>ip-netns - process network namespace management</strong> 這個指令來查看不同 namespace 底下的流量。</p>
<p>具體方式如下：</p>
<ol>
<li><p>取得 Container PID, 這邊我查看名為 wordpress_wordpress_1 的 container</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">λ ~/docker inspect -f &apos;&#123;&#123; .State.Pid &#125;&#125;&apos; wordpress_wordpress_1</span><br><span class="line">658</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立連結至 /var/run/netns/ 供 ip netns 使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">λ ~/sudo ln -sf /proc/658/ns/net /var/run/netns/wordpress</span><br></pre></td></tr></table></figure>
</li>
<li><p>利用 ip netns 接 iptables 流量就一目了然了！</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">λ ~/sudo ip netns exec wordpress iptables -L -nv</span><br><span class="line">Chain INPUT (policy ACCEPT 639 packets, 106K bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 610 packets, 882K bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Reference: <a href="http://serverfault.com/questions/615854/counting-bandwidth-from-a-docker-container" rel="external nofollow" target="_blank">Counting bandwidth from a Docker container</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/rsyslog-config-order-matters/" itemprop="url">
                  Rsyslog 設定順序是有差別的 (開啟 UDP bind 127.0.0.1)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-03T17:05:51+00:00" content="1月 3 2016">
              1月 3 2016
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/rsyslog-config-order-matters/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/rsyslog-config-order-matters/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在設定 Rsyslog 時，預設 Debian 7 沒有打開 local udp 514 port 接收的功能。所我就簡單加入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514</span><br></pre></td></tr></table></figure>
<p>後來發現，預設是 bind 在 <code>0.0.0.0</code> 相當之危險～等於所有人都可以打 log 到你機器上，於是我又再加入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514</span><br><span class="line">$UDPServerAddress 127.0.0.1</span><br></pre></td></tr></table></figure>
<p>發現沒有用，還是 bind 在 <code>0.0.0.0</code>，死馬當活馬醫…調整一下順序：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerAddress 127.0.0.1</span><br><span class="line">$UDPServerRun 514</span><br></pre></td></tr></table></figure>
<p>這樣就可以了（暈），原來 Rsyslog 的設定順序是不可逆的。找個時間可以再深入研究一下…（遠目）</p>
<p>檢查一下 <code>netstat -nlp | grep 514</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">udp        0      0 127.0.0.1:514           0.0.0.0:*                           12274/rsyslogd</span><br></pre></td></tr></table></figure>
<p>打完收工。</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/ssh-remote-sendenv-locale-issue/" itemprop="url">
                  關閉 SSH SendENV 解決 locale 問題
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-01-03T16:59:29+00:00" content="1月 3 2016">
              1月 3 2016
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/ssh-remote-sendenv-locale-issue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/ssh-remote-sendenv-locale-issue/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前幾天遇到一個詭異的問題，就是我使用 ssh 登入遠端 Server，執行特定程式會發生 locale 的問題，看了一下 <code>locales</code>…</p>
<p>驚人的事情發生了！因為同事電腦登入過去一樣下 <code>locales</code> 居然跟我的不一樣…這是什麼妖術？</p>
<p>原來，預設 ssh 會預設傳送本地端的 env 到遠端 server ，為了解決此問題只要編輯 <code>/etc/ssh/ssh_config</code>，把 <code>SendEnv</code> 這一行註解掉即可。</p>
<p>原本錯誤訊息可能長這樣：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">perl: warning: Setting locale failed.</span><br><span class="line">perl: warning: Please check that your locale settings:</span><br><span class="line">        LANGUAGE = (unset),</span><br><span class="line">        LC_ALL = (unset),</span><br><span class="line">        LC_PAPER = &quot;de_DE.UTF-8&quot;,</span><br><span class="line">        LC_CTYPE = &quot;de_DE@euro&quot;,</span><br><span class="line">        LANG = &quot;en_US.UTF-8&quot;</span><br><span class="line">    are supported and installed on your system.</span><br><span class="line">perl: warning: Falling back to the standard locale (&quot;C&quot;).</span><br></pre></td></tr></table></figure></p>
<p>或這樣<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">locale: Cannot set LC_CTYPE to default locale: No such file or directory</span><br><span class="line">locale: Cannot set LC_ALL to default locale: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>reference: <a href="http://www.jerri.de/blog/archives/2009/12/04/problem_with_locales_on_remote_server_via_ssh/" rel="external nofollow" target="_blank">http://www.jerri.de/blog/archives/2009/12/04/problem_with_locales_on_remote_server_via_ssh/</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/wireshark-remote-ssh-tcpdump/" itemprop="url">
                  Wireshark x ssh x tcpdump 遠端偵錯
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2015-12-15T01:21:43+00:00" content="12月 15 2015">
              12月 15 2015
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/wireshark-remote-ssh-tcpdump/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/wireshark-remote-ssh-tcpdump/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近工作常常需要用到 <strong>Wireshark</strong> 來看看一些怪怪的問題…</p>
<p>如果是要除錯一般 ethernet 就還好，可以借一台具備 Port Mirror 功能的 Switch 來除錯，但是如果遇到像是 WiFi 或 Cellular 這種無線介面，就只能用 <strong>TCPDUMP</strong> 擋著…</p>
<p>但是，光是從 console 觀察 TCPDUMP 資訊實在很費工夫，好在 Wireshark 有提供從 stdin pipe 進來的機制 (當然，你也可以用 tcpdump 存成檔案在用 Wireshark 來讀取)</p>
<p>於是乎，只要下…</p>
<h3 id="Linux-Mac"><a href="#Linux-Mac" class="headerlink" title="Linux / Mac"></a>Linux / Mac</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh <span class="_">-l</span> root 192.168.3.127 tcpdump -U <span class="_">-s</span>0 -w - -i eth1 | wireshark -k -i -</span><br></pre></td></tr></table></figure>
<p>eth1 換成你要的介面</p>
<h3 id="Windows-without-cygwin"><a href="#Windows-without-cygwin" class="headerlink" title="Windows (without cygwin)"></a>Windows (without cygwin)</h3><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">plink.exe -ssh -pw abc123 root@<span class="number">192</span>.<span class="number">168</span>.<span class="number">2</span>.<span class="number">1</span> "tcpdump -ni eth0 -s <span class="number">0</span> -w - <span class="keyword">not</span> port <span class="number">22</span>" | "C:\Program Files\Wireshark\Wireshark.exe" -k -i -</span><br></pre></td></tr></table></figure>
<p>其中 plink 可前往 putty 下載頁面 <a href="">Download</a></p>
<p>Reference:</p>
<ul>
<li><a href="https://ask.wireshark.org/questions/23609/remote-capture-via-ssh-and-pipe" rel="external nofollow" target="_blank">Remote capture via ssh and pipe</a></li>
</ul>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/natural-sort-version-numbers-within-text/" itemprop="url">
                  依照檔名中版本號碼排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2015-11-06T20:00:00+00:00" content="11月 6 2015">
              11月 6 2015
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/natural-sort-version-numbers-within-text/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/natural-sort-version-numbers-within-text/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>ls -v</code> 可以依照檔名中的版本來排序，根本太強大啊！</p>
<p><strong>Before -v</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@zack:/unstable# ls i-feel-so-good*.deb -alh</span><br><span class="line"></span><br><span class="line">-rw-rw-r-- 1 zack zack 2.2M Sep 14 11:41 i-feel-so-good0.9.0_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.7M Oct 13 17:40 i-feel-so-good0.9.10_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.9M Oct 29 10:48 i-feel-so-good0.9.11_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.8M Sep 22 17:25 i-feel-so-good0.9.1_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.8M Sep 22 17:55 i-feel-so-good0.9.2_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.8M Sep 24 15:28 i-feel-so-good0.9.3_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.8M Sep 30 18:04 i-feel-so-good0.9.5_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.8M Sep 30 18:41 i-feel-so-good0.9.6_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.8M Oct  2 18:01 i-feel-so-good0.9.7_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.7M Oct 13 10:17 i-feel-so-good0.9.8_all.deb</span><br><span class="line">-rw-rw-r-- 1 zack zack 1.7M Oct 13 10:42 i-feel-so-good0.9.9_all.deb</span><br></pre></td></tr></table></figure>
<p><strong>After -v</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@zack:/unstable# ls i-feel-so-good*.deb -avlh</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 2.2M Sep 14 11:41 i-feel-so-good0.9.0_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.8M Sep 22 17:25 i-feel-so-good0.9.1_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.8M Sep 22 17:55 i-feel-so-good0.9.2_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.8M Sep 24 15:28 i-feel-so-good0.9.3_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.8M Sep 30 18:04 i-feel-so-good0.9.5_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.8M Sep 30 18:41 i-feel-so-good0.9.6_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.8M Oct  2 18:01 i-feel-so-good0.9.7_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.7M Oct 13 10:17 i-feel-so-good0.9.8_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.7M Oct 13 10:42 i-feel-so-good0.9.9_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.7M Oct 13 17:40 i-feel-so-good0.9.10_all.deb</span><br><span class="line">-rw-rw-r-- 1 apt-server apt-server 1.9M Oct 29 10:48 i-feel-so-good0.9.11_all.deb</span><br></pre></td></tr></table></figure>
<p>又學到一招了！</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/wordpress-docker-image-armhf/" itemprop="url">
                  秒建 WordPress 在你閒置的 Raspberry Pi 上
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2015-11-01T00:00:20+00:00" content="11月 1 2015">
              11月 1 2015
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/wordpress-docker-image-armhf/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/wordpress-docker-image-armhf/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近把吃喝玩樂 Blog 從 Blogspot 搬到 WordPress 了！於是乎就想要玩玩各種功能…</p>
<p>Production 環境目前是 host 在 DigitalOcean ，看了旁邊的 Raspberry Pi 一眼好像閒著也是閒著，於是上網看看有沒有現成的 Docker Image 可以用，結果找不到喜歡的。就自己 Build 一個吧！</p>
<p>英文說明與 Dockerfile, Scripts 都在 Github 連結：<a href="https://github.com/imZack/wordpress-armhf" rel="external nofollow" target="_blank">imZack/wordpress-armhf</a></p>
<p>這邊主要會用到兩個 Image 分別是 <code>zack/wordpress-armhf:4.3.1-apache</code> 與 <code>armbuilds/mariadb</code>，詳細的 Dockerfile 可以在上面 Github 連結裡面找到。由於 Docker Hub 無法自動 Build armhf 的 Image 所以我必須先在 Raspberry Pi 上 build 好然後再推上去。(另有用 QEMU 方式，這邊先不多提…)</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">wordpress:</span></span><br><span class="line"><span class="attr">    image:</span> zack/wordpress-armhf:<span class="number">4.3</span><span class="number">.1</span>-apache</span><br><span class="line"><span class="attr">    restart:</span> always</span><br><span class="line"><span class="attr">    links:</span></span><br><span class="line"><span class="bullet">     -</span> mysql</span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">     -</span> WORDPRESS_DB_PASSWORD=wordpressmeetsdocker</span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">"8080:80"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">     -</span> ./www-data:/var/www/html</span><br><span class="line"></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line"><span class="attr">    image:</span> armbuilds/mariadb</span><br><span class="line"><span class="attr">    restart:</span> always</span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">     -</span> ./mysql-data:/var/lib/mysql</span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">     -</span> MYSQL_ROOT_PASSWORD=wordpressmeetsdocker</span><br><span class="line"><span class="bullet">     -</span> MYSQL_DATABASE=wordpress</span><br></pre></td></tr></table></figure>
<p>用上面的 docker-compose.yml 就能在幾秒內建立一個全新的 WordPress 環境囉！</p>
<p>只需要下 <code>docker-compose up</code> 等他跑完初始化，就能開啟 <a href="http://localhost:8080" rel="external nofollow" target="_blank">http://localhost:8080</a> Port 囉 ！</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/netfilter-framework-linux-iptables/" itemprop="url">
                  淺讀 Netfilter Framework
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2015-10-29T22:16:40+00:00" content="10月 29 2015">
              10月 29 2015
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/netfilter-framework-linux-iptables/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/netfilter-framework-linux-iptables/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><ul>
<li>Linux 2.3.x 時期 Paul Rusty Russel 寫的</li>
<li>基本上就是插入一些 Hooks 到 Kernel module</li>
<li>Iptables 常常跟 Netfilter Framework 搞混，Iptables 屬於 Netfilter Framework 的一員</li>
</ul>
<h2 id="Hooks-and-The-Callback-Functions"><a href="#Hooks-and-The-Callback-Functions" class="headerlink" title="Hooks and The Callback Functions"></a>Hooks and The Callback Functions</h2><p>有五種 Hooks 會插入在 Linux networking stack 中的不同階段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--&gt; PREROUTING ---&gt; [ROUTE] ---&gt; FORWARD -------------------&gt; POSTROUTING --&gt;</span><br><span class="line">                      |                              ^</span><br><span class="line">                      |                              |</span><br><span class="line">                      |                           [ROUTE]</span><br><span class="line">                      V                              |</span><br><span class="line">                   LOCAL IN ---&gt; LOCAL PROCESS --&gt; LOCAL OUT</span><br></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/netfilter-framework-linux-iptables/#more" rel="contents">
              閱讀全文 &raquo;
            </a>
          </div>
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/default_avatar.jpg"
               alt="YuLun Shih" />
          <p class="site-author-name" itemprop="name">YuLun Shih</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">66</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分類</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">122</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YuLun Shih</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'zacksnote';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  



  
  
  

  

  

</body>
</html>
